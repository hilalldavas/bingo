import Foundation
import Combine
import FirebaseAuth

class AuthViewModel: ObservableObject {
    @Published var email = ""
    @Published var password = ""
    @Published var fullName = ""
    @Published var username = ""
    @Published var errorMessage = ""
    @Published var infoMessage = ""
    @Published var isLoggedIn = false
    @Published var showVerificationScreen = false
    @Published var isCheckingUsername = false
    @Published var usernameMessage = ""
    @Published var showPasswordReset = false
    @Published var isPasswordResetLoading = false

    // Email ve ≈üifre realtime kontrol
    var emailMessage: String? {
        if email.isEmpty { return nil }
        let regex = "[A-Z0-9a-z._%+-]+@[A-Za-z0-9.-]+\\.[A-Za-z]{2,}"
        return NSPredicate(format: "SELF MATCHES %@", regex).evaluate(with: email) ? nil : "Ge√ßersiz email"
    }

    var passwordMessage: String? {
        if password.isEmpty { return nil }
        if password.count < 6 { return "≈ûifre √ßok kƒ±sa (min 6 karakter)" }
        if password.rangeOfCharacter(from: .uppercaseLetters) == nil { return "En az bir b√ºy√ºk harf" }
        if password.rangeOfCharacter(from: .decimalDigits) == nil { return "En az bir rakam" }
        return "≈ûifre g√º√ßl√º ‚úÖ"
    }

    // Signup
    func signup() {
        if let emailErr = emailMessage {
            self.errorMessage = emailErr
            return
        }

        if let passwordErr = passwordMessage, passwordErr != "≈ûifre g√º√ßl√º ‚úÖ" {
            self.errorMessage = passwordErr
            return
        }
        
        // Check username message for errors
        if !usernameMessage.isEmpty && !usernameMessage.contains("‚úÖ") {
            self.errorMessage = usernameMessage
            return
        }
        
        if username.isEmpty {
            self.errorMessage = "Kullanƒ±cƒ± adƒ± gerekli"
            return
        }
        
        if fullName.isEmpty {
            self.errorMessage = "Ad ve soyad gerekli"
            return
        }

        // √ñnce username kontrol√º yap - EMAƒ∞L G√ñNDERƒ∞LMEDEN √ñNCE
        print("DEBUG: Signup - Username kontrol√º ba≈ülatƒ±lƒ±yor: '\(username)'")
        SocialMediaService.shared.checkUsernameAvailability(username: username, currentUserId: "") { [weak self] result in
            DispatchQueue.main.async {
                guard let self = self else { return }
                
                switch result {
                case .success(let isAvailable):
                    if isAvailable {
                        print("DEBUG: Signup - Username m√ºsait, kayƒ±t i≈ülemi ba≈ülatƒ±lƒ±yor")
                        self.performSignup()
                    } else {
                        self.errorMessage = "Bu kullanƒ±cƒ± adƒ± zaten alƒ±nmƒ±≈ü. L√ºtfen ba≈üka bir kullanƒ±cƒ± adƒ± se√ßin."
                    }
                case .failure(let error):
                    print("DEBUG: Signup - Username kontrol hatasƒ±: \(error.localizedDescription)")
                    // Hata durumunda da kayƒ±t i≈ülemini devam ettir (Firebase kurallarƒ± sorunu olabilir)
                    self.performSignup()
                }
            }
        }
    }
    
    private func performSignup() {
        Auth.auth().createUser(withEmail: email, password: password) { [weak self] result, error in
            DispatchQueue.main.async {
                guard let self = self else { return }
                
                if let error = error {
                    self.errorMessage = error.localizedDescription
                    return
                }
                
                guard let currentUser = Auth.auth().currentUser else {
                    self.errorMessage = "Kullanƒ±cƒ± olu≈üturulamadƒ±"
                    return
                }
                
                // √ñnce kullanƒ±cƒ± profilini olu≈ütur (username database'e kaydedilsin)
                let userProfile = UserProfileModel(
                    email: self.email,
                    username: self.username,
                    fullName: self.fullName,
                    bio: "Bingo Social'da yeni bir yolculuƒüa ba≈üladƒ±m! üéØ",
                    profileImageURL: "https://ui-avatars.com/api/?name=\(self.fullName.addingPercentEncoding(withAllowedCharacters: .urlQueryAllowed) ?? "User")&background=random&color=fff&size=200"
                )
                
                var profile = userProfile
                profile.id = currentUser.uid
                
                print("DEBUG: Signup - Profil olu≈üturuluyor: \(profile.username)")
                
                // Profili Firestore'a kaydet
                SocialMediaService.shared.createUserProfile(userProfile: profile) { profileResult in
                    DispatchQueue.main.async {
                        switch profileResult {
                        case .success:
                            print("DEBUG: Signup - Profil ba≈üarƒ±yla olu≈üturuldu")
                            
                            // Profil olu≈üturulduktan sonra email doƒürulama linki g√∂nder
                            Auth.auth().currentUser?.sendEmailVerification { emailError in
                                DispatchQueue.main.async {
                                    if let emailError = emailError {
                                        self.errorMessage = emailError.localizedDescription
                                    } else {
                                        self.infoMessage = "Doƒürulama linki email adresinize g√∂nderildi. L√ºtfen mailinizi kontrol edin."
                                        self.showVerificationScreen = true
                                    }
                                }
                            }
                            
                        case .failure(let error):
                            print("DEBUG: Signup - Profil olu≈üturma hatasƒ±: \(error.localizedDescription)")
                            self.errorMessage = "Profil olu≈üturulamadƒ±: \(error.localizedDescription)"
                            
                            // Profil olu≈üturulamazsa kullanƒ±cƒ±yƒ± sil
                            currentUser.delete { _ in
                                print("DEBUG: Signup - Kullanƒ±cƒ± silindi (profil olu≈üturulamadƒ±)")
                            }
                        }
                    }
                }
            }
        }
    }

    // Login
    func login() {
        // Info mesajƒ±nƒ± temizle
        self.infoMessage = ""
        
        Auth.auth().signIn(withEmail: email, password: password) { [weak self] result, error in
            DispatchQueue.main.async {
                if let error = error {
                    // Silinmi≈ü kullanƒ±cƒ± hatasƒ± i√ßin √∂zel mesaj
                    let nsError = error as NSError
                    if nsError.code == 17011 { // User not found
                        self?.errorMessage = "Bu hesap silinmi≈ü veya mevcut deƒüil. L√ºtfen yeni bir hesap olu≈üturun."
                    } else {
                        self?.errorMessage = error.localizedDescription
                    }
                    return
                }

                guard let user = Auth.auth().currentUser else { return }

                if user.isEmailVerified {
                    // Hesap dondurulmu≈ü mu kontrol et
                    self?.checkAccountStatus(userId: user.uid)
                } else {
                    self?.errorMessage = "Email doƒürulanmadƒ±. L√ºtfen mailinizi kontrol edin ve linke tƒ±klayƒ±n."
                    self?.showVerificationScreen = true
                }
            }
        }
    }

    // Eski kullanƒ±cƒ±lar i√ßin backward compatibility - profil yoksa varsayƒ±lan profil olu≈ütur
    private func ensureProfileExists() {
        guard let currentUser = Auth.auth().currentUser else { return }
        
        SocialMediaService.shared.fetchUserProfile(userId: currentUser.uid) { result in
            switch result {
            case .success(let profile):
                if profile == nil {
                    print("DEBUG: Eski kullanƒ±cƒ± i√ßin profil olu≈üturuluyor...")
                    // Profil yoksa varsayƒ±lan profil olu≈ütur
                    let email = currentUser.email ?? "kullanici@example.com"
                    let emailPrefix = email.components(separatedBy: "@").first ?? "kullanici"
                    
                    let defaultProfile = UserProfileModel(
                        email: email,
                        username: "kullanici_\(currentUser.uid.prefix(8))",
                        fullName: emailPrefix.capitalized,
                        bio: "Bingo Social kullanƒ±cƒ±sƒ±",
                        profileImageURL: "https://ui-avatars.com/api/?name=\(emailPrefix.addingPercentEncoding(withAllowedCharacters: .urlQueryAllowed) ?? "User")&background=random&color=fff&size=200"
                    )
                    
                    var newProfile = defaultProfile
                    newProfile.id = currentUser.uid
                    
                    SocialMediaService.shared.createUserProfile(userProfile: newProfile) { result in
                        switch result {
                        case .success:
                            print("DEBUG: Varsayƒ±lan profil ba≈üarƒ±yla olu≈üturuldu")
                        case .failure(let error):
                            print("DEBUG: Profil olu≈üturma hatasƒ±: \(error.localizedDescription)")
                        }
                    }
                } else {
                    print("DEBUG: Kullanƒ±cƒ± profili zaten mevcut")
                }
            case .failure(let error):
                print("DEBUG: Profil kontrol√º hatasƒ±: \(error.localizedDescription)")
            }
        }
    }
    
    // Password Reset
    func resetPassword() {
        guard !email.isEmpty else {
            errorMessage = "L√ºtfen email adresinizi girin"
            return
        }
        
        guard emailMessage == nil else {
            errorMessage = "L√ºtfen ge√ßerli bir email adresi girin"
            return
        }
        
        isPasswordResetLoading = true
        errorMessage = ""
        infoMessage = ""
        
        Auth.auth().sendPasswordReset(withEmail: email) { [weak self] error in
            DispatchQueue.main.async {
                self?.isPasswordResetLoading = false
                
                if let error = error {
                    self?.errorMessage = error.localizedDescription
                } else {
                    self?.infoMessage = "≈ûifre sƒ±fƒ±rlama linki \(self?.email ?? "") adresine g√∂nderildi. L√ºtfen mailinizi kontrol edin."
                    self?.showPasswordReset = false
                }
            }
        }
    }
    
    func logout() {
        do {
            try Auth.auth().signOut()
            self.isLoggedIn = false
            self.showVerificationScreen = false
            self.email = ""
            self.password = ""
            self.fullName = ""
            self.username = ""
            self.errorMessage = ""
            self.infoMessage = ""
            self.isCheckingUsername = false
            self.usernameMessage = ""
            self.showPasswordReset = false
            self.isPasswordResetLoading = false
        } catch {
            self.errorMessage = error.localizedDescription
        }
    }
    
    // MARK: - Account Status Check
    
    /// Hesap durumunu kontrol eder (aktif, dondurulmu≈ü, silinmi≈ü)
    private func checkAccountStatus(userId: String) {
        print("DEBUG: Hesap durumu kontrol ediliyor - UserID: \(userId)")
        
        // √ñnce 30 g√ºn ge√ßmi≈ü hesaplarƒ± kontrol et
        SocialMediaService.shared.checkAndDeleteExpiredDeactivatedAccounts(userId: userId) { [weak self] result in
            DispatchQueue.main.async {
                guard let self = self else { return }
                
                switch result {
                case .success(let wasDeleted):
                    if wasDeleted {
                        // Hesap 30 g√ºn ge√ßtiƒüi i√ßin silindi
                        print("DEBUG: Hesap 30 g√ºn ge√ßtiƒüi i√ßin kalƒ±cƒ± olarak silindi")
                        self.errorMessage = "Hesabƒ±nƒ±z 30 g√ºnden fazla dondurulduƒüu i√ßin kalƒ±cƒ± olarak silindi. L√ºtfen yeni bir hesap olu≈üturun."
                        self.logout()
                        return
                    }
                    
                    // Hesap durumunu kontrol et
                    SocialMediaService.shared.fetchUserProfile(userId: userId) { profileResult in
                        DispatchQueue.main.async {
                            switch profileResult {
                            case .success(let profile):
                                if let profile = profile {
                                    if profile.isDeactivated {
                                        // Hesap dondurulmu≈ü - reaktive et
                                        let daysRemaining = self.calculateRemainingDays(from: profile.deactivatedAt)
                                        print("DEBUG: Hesap dondurulmu≈ü, yeniden aktifle≈ütiriliyor. Kalan g√ºn: \(daysRemaining)")
                                        
                                        self.reactivateAccount(userId: userId)
                                    } else {
                                        // Hesap aktif
                                        self.isLoggedIn = true
                                        self.errorMessage = ""
                                        self.showVerificationScreen = false
                                        self.ensureProfileExists()
                                    }
                                } else {
                                    // Profil bulunamadƒ±
                                    self.errorMessage = "Hesabƒ±nƒ±z sistemden silinmi≈ü. L√ºtfen tekrar kayƒ±t olun."
                                    self.logout()
                                }
                            case .failure(let error):
                                print("DEBUG: Profil kontrol√º hatasƒ±: \(error.localizedDescription)")
                                // Hata durumunda yine de giri≈ü yap
                                self.isLoggedIn = true
                                self.ensureProfileExists()
                            }
                        }
                    }
                    
                case .failure(let error):
                    print("DEBUG: Deactivation kontrol√º hatasƒ±: \(error.localizedDescription)")
                    // Hata durumunda normal login devam etsin
                    self.isLoggedIn = true
                    self.ensureProfileExists()
                }
            }
        }
    }
    
    /// Hesabƒ± yeniden aktifle≈ütirir
    private func reactivateAccount(userId: String) {
        SocialMediaService.shared.reactivateAccount(userId: userId) { [weak self] result in
            DispatchQueue.main.async {
                guard let self = self else { return }
                
                switch result {
                case .success:
                    print("DEBUG: Hesap ba≈üarƒ±yla yeniden aktifle≈ütirildi")
                    self.isLoggedIn = true
                    self.errorMessage = ""
                    self.infoMessage = "Tekrar ho≈ü geldiniz! Hesabƒ±nƒ±z yeniden aktifle≈ütirildi."
                    self.showVerificationScreen = false
                case .failure(let error):
                    print("DEBUG: Hesap aktifle≈ütirme hatasƒ±: \(error.localizedDescription)")
                    self.errorMessage = "Hesap aktifle≈ütirilemedi: \(error.localizedDescription)"
                }
            }
        }
    }
    
    /// Dondurulmu≈ü hesap i√ßin kalan g√ºn sayƒ±sƒ±nƒ± hesaplar
    private func calculateRemainingDays(from deactivatedAt: Date?) -> Int {
        guard let deactivatedAt = deactivatedAt else { return 30 }
        let daysPassed = Calendar.current.dateComponents([.day], from: deactivatedAt, to: Date()).day ?? 0
        return max(0, 30 - daysPassed)
    }
    
    // MARK: - User Profile Validation
    
    /// Firestore'da kullanƒ±cƒ± profili var mƒ± kontrol eder
    /// Profil silinmi≈üse kullanƒ±cƒ±yƒ± √ßƒ±kƒ±≈ü yapar
    func validateUserProfile() {
        guard let currentUser = Auth.auth().currentUser else {
            print("DEBUG: validateUserProfile - Kullanƒ±cƒ± giri≈ü yapmamƒ±≈ü")
            self.isLoggedIn = false
            return
        }
        
        print("DEBUG: validateUserProfile - Profil kontrol√º ba≈ülatƒ±lƒ±yor: \(currentUser.uid)")
        
        SocialMediaService.shared.fetchUserProfile(userId: currentUser.uid) { [weak self] result in
            DispatchQueue.main.async {
                guard let self = self else { return }
                
                switch result {
                case .success(let profile):
                    if profile == nil {
                        // Profil bulunamadƒ± - kullanƒ±cƒ± veritabanƒ±ndan silinmi≈ü
                        print("DEBUG: validateUserProfile - Profil bulunamadƒ±! Kullanƒ±cƒ± √ßƒ±kƒ±≈ü yapƒ±lƒ±yor...")
                        self.errorMessage = "Hesabƒ±nƒ±z sistemden silinmi≈ü. L√ºtfen tekrar kayƒ±t olun."
                        self.logout()
                    } else {
                        print("DEBUG: validateUserProfile - Profil mevcut, kullanƒ±cƒ± ge√ßerli")
                    }
                case .failure(let error):
                    print("DEBUG: validateUserProfile - Hata: \(error.localizedDescription)")
                    // Network hatasƒ± vs olabilir, kullanƒ±cƒ±yƒ± √ßƒ±karmayalƒ±m
                    // Sadece kritik hatalarda √ßƒ±kƒ±≈ü yapalƒ±m
                }
            }
        }
    }
}
